<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Axiom Global & Private Chat -- Axiom Republic</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:flex;height:100vh;margin:0;background:#f8f9fa;}
.sidebar{width:320px;border-right:1px solid #eee;padding:16px;box-sizing:border-box;overflow:auto;background:#fff;transition:all 0.3s ease;}
.main{flex:1;display:flex;flex-direction:column}
.header{padding:12px;border-bottom:1px solid #eee;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
.messages{flex:1;padding:12px;overflow:auto;background:#f8f9fa;}
.composer{display:flex;padding:12px;border-top:1px solid #eee;background:#fff;}
.composer input{flex:1;padding:8px;margin-right:8px;border:1px solid #ddd;border-radius:20px;transition:all 0.3s ease;}
.composer input:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 0 2px rgba(74,144,226,0.2);}
button{padding:8px 12px;cursor:pointer;border:none;border-radius:6px;transition:all 0.2s ease;}
.friend, .chat-btn{padding:8px;border-radius:6px;cursor:pointer;margin-bottom:4px;transition:all 0.2s ease;position:relative;}
.friend:hover, .chat-btn:hover{background:#f0f5ff;transform:translateY(-1px);}
.me{color:green}
.msg{margin:8px 0;padding:8px 12px;border-radius:12px;max-width:80%;animation:fadeIn 0.3s ease;position:relative;}
.msg .from{font-weight:600}
form{display:flex;flex-direction:column;gap:8px}
input[type=text],input[type=password]{padding:8px;border:1px solid #ddd;border-radius:4px;transition:all 0.3s ease;}
input[type=text]:focus,input[type=password]:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 0 2px rgba(74,144,226,0.2);}
h4{margin-top:12px;margin-bottom:4px;}
.status-dot{font-weight:bold;margin-right:4px;}

/* New styles for enhanced UI */
#auth-area {animation: fadeIn 0.5s ease;}
#friends-area {animation: slideIn 0.5s ease;}

/* Message styles */
.msg.own {background:#e3f2fd;margin-left:auto;border-bottom-right-radius:4px;}
.msg.other {background:#fff;border:1px solid #e0e0e0;border-bottom-left-radius:4px;}

/* Status indicators */
.status-online {color:#4caf50;}
.status-offline {color:#9e9e9e;}
.status-typing {color:#ff9800;}

/* Typing indicator animation */
.typing-indicator {
  display: inline-block;
  margin-left: 8px;
}
.typing-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #999;
  margin-right: 2px;
  animation: typing 1.4s infinite ease-in-out;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* Button styles */
.btn-primary {background:#4a90e2;color:white;}
.btn-primary:hover {background:#3a7bc8;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.btn-secondary {background:#f5f5f5;color:#333;}
.btn-secondary:hover {background:#e0e0e0;}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateX(-20px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-5px); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes messageSlide {
  from { transform: translateY(10px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Message outline flash effects - FIXED EQUAL SPEED */
/* Message outline flash effects - FIXED HEIGHT ISSUE */
/* Message outline flash effects - FIXED WHITE FLASH */
/* Message outline flash effects - NO OUTLINE, ONLY BOX-SHADOW */
/* Message outline flash effects - BIG DRAMATIC GLOW */
@keyframes outlineFlashSend {
  0%, 100% { 
    box-shadow: 
      0 0 0 0 rgba(74, 144, 226, 0),
      0 0 0 0 rgba(74, 144, 226, 0);
  }
  50% { 
    box-shadow: 
      0 0 0 8px rgba(74, 144, 226, 0.4),
      0 0 0 16px rgba(74, 144, 226, 0.2);
  }
}

@keyframes outlineFlashReceive {
  0%, 100% { 
    box-shadow: 
      0 0 0 0 rgba(76, 175, 80, 0),
      0 0 0 0 rgba(76, 175, 80, 0);
  }
  50% { 
    box-shadow: 
      0 0 0 8px rgba(76, 175, 80, 0.4),
      0 0 0 16px rgba(76, 175, 80, 0.2);
  }
}

.msg.own.flash {
  animation: messageSlide 0.4s ease, outlineFlashSend 1s ease-in-out;
}

.msg.other.flash {
  animation: messageSlide 0.4s ease, outlineFlashReceive 1s ease-in-out;
}

.msg.own.flash {
  animation: messageSlide 0.4s ease, outlineFlashSend 1s ease-in-out;
}

.msg.other.flash {
  animation: messageSlide 0.4s ease, outlineFlashReceive 1s ease-in-out;
}

.msg.own.flash {
  animation: messageSlide 0.4s ease, outlineFlashSend 1.5s ease;
}

.msg.other.flash {
  animation: messageSlide 0.4s ease, outlineFlashReceive 1.5s ease;
}

/* Friend request styles */
.friend-request {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-radius: 6px;
  background: #f9f9f9;
  margin-bottom: 4px;
  animation: fadeIn 0.3s ease;
}

.friend-request-buttons {
  display: flex;
  gap: 4px;
}

/* Selected friend highlight */
.friend.selected {
  background: #e3f2fd;
  border-left: 3px solid #4a90e2;
}

/* Global chat button highlight */
#global-chat-btn.selected {
  background: #e3f2fd;
  border-left: 3px solid #4a90e2;
}

/* Message timestamp */
.msg-time {
  font-size: 0.7rem;
  color: #999;
  margin-left: 8px;
}

/* Online users counter */
.online-counter {
  display: inline-block;
  background: #4caf50;
  color: white;
  border-radius: 10px;
  padding: 2px 8px;
  font-size: 0.8rem;
  margin-left: 8px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  body { flex-direction: column; }
  .sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #eee; }
  .msg { max-width: 90%; }
}
</style>
</head>
<body>
<div class="sidebar">
  <div id="auth-area">
    <h3>Sign up / Sign in</h3>
    <form id="signup-form">
      <input id="signup-username" type="text" placeholder="Username" required>
      <input id="signup-password" type="password" placeholder="Password" required>
      <div style="display:flex;gap:8px">
        <button type="submit" class="btn-primary">Sign up</button>
        <button type="button" id="show-signin" class="btn-secondary">Sign in</button>
      </div>
    </form>
    <form id="signin-form" style="display:none">
      <input id="signin-username" type="text" placeholder="Username" required>
      <input id="signin-password" type="password" placeholder="Password" required>
      <div style="display:flex;gap:8px">
        <button type="submit" class="btn-primary">Sign in</button>
        <button type="button" id="show-signup" class="btn-secondary">Back</button>
      </div>
    </form>
  </div>

  <div id="friends-area" style="display:none">
    <h3>Chats <span id="online-counter" class="online-counter">0</span></h3>
    <button class="chat-btn" id="global-chat-btn">üåê Global Chat</button>
    <h4>Friends</h4>
    <div style="display:flex;gap:4px">
      <input id="friend-username" type="text" placeholder="Friend's username">
      <button id="add-friend" class="btn-primary">Add</button>
    </div>
    <div id="friends-list"></div>

    <h4>Pending Requests</h4>
    <div id="pending-requests"></div>
  </div>
</div>

<div class="main">
  <div class="header"><h3 id="chat-title">Chat</h3></div>
  <div class="messages" id="messages"></div>
  <div class="composer">
    <input id="message-input" type="text" placeholder="Type a message">
    <button id="send-msg" class="btn-primary">Send</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://flzvylfpxwxkjcfjnvrm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsenZ5bGZweHd4a2pjZmpudnJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMjEyODIsImV4cCI6MjA3NTg5NzI4Mn0._sOnyQliXMUxHOyRGGagA8iuP9qFjAetyX8wfuc0iII';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Message memory to track which messages have already been shown
const messageMemory = new Set();

const signupForm = document.getElementById('signup-form');
const signinForm = document.getElementById('signin-form');
document.getElementById('show-signin').onclick=()=>{
  signupForm.style.display='none'; 
  signinForm.style.display='block';
  signinForm.style.animation = 'fadeIn 0.3s ease';
}
document.getElementById('show-signup').onclick=()=>{
  signinForm.style.display='none'; 
  signupForm.style.display='block';
  signupForm.style.animation = 'fadeIn 0.3s ease';
}

function hashPass(pass){ return btoa(pass); }

let currentUser={id:null, username:null};
let currentFriend=null;
let currentFriendName='';
let typingTimeout=null;

// Online status
async function setOnline(status){ if(!currentUser.id) return; await supabase.from('profiles').update({online:status}).eq('id',currentUser.id);}
window.addEventListener('beforeunload', ()=>setOnline(false));

// Generate a unique message ID for tracking
function generateMessageId(message) {
  return `${message.from_id}-${message.to_id}-${message.content}-${message.created_at}`;
}

// --- Signup
signupForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const username = document.getElementById('signup-username').value;
  const password_hash = hashPass(document.getElementById('signup-password').value);

  const { data: existing } = await supabase.from('profiles').select('id').eq('username', username).single();
  if(existing){alert('Username taken'); return;}

  const { data, error } = await supabase.from('profiles').insert({username, password_hash, online:true}).select().single();
  if(error){alert(error.message);} else {
    initChat(data.username, data.id);
  }
});

// --- Signin
signinForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const username = document.getElementById('signin-username').value;
  const password_hash = hashPass(document.getElementById('signin-password').value);

  const { data, error } = await supabase.from('profiles').select('*').eq('username', username).eq('password_hash', password_hash).single();
  if(error || !data){alert('Invalid username/password'); return;}
  initChat(data.username, data.id);
});

// --- Init chat
async function initChat(username, uid){
  currentUser={id:uid, username};
  document.getElementById('auth-area').style.display='none';
  document.getElementById('friends-area').style.display='block';
  await setOnline(true);

  async function loadFriends(){
    const { data: friends } = await supabase.from('friendships').select('id, requester_id, requested_id, status');
    const list=document.getElementById('friends-list'); list.innerHTML='';
    for(const f of friends){
      let fid = f.requester_id===currentUser.id?f.requested_id:(f.requested_id===currentUser.id?f.requester_id:null);
      if(!fid || f.status!=='accepted') continue;
      const { data: profile } = await supabase.from('profiles').select('username, online, typing').eq('id',fid).single();
      const div=document.createElement('div'); 
      div.className = `friend ${currentFriend === fid ? 'selected' : ''}`;
      div.setAttribute('data-id', fid);
      
      let typingIndicator = '';
      if (profile.typing) {
        typingIndicator = `<span class="typing-indicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </span>`;
      }
      // Get the actual sender's username for display
      const senderName = m.from_id === currentUser.id ? 'You' : await getUsernameById(m.from_id);
      div.innerHTML=`<span class="from">${senderName}</span><span class="msg-time">${timeStr}</span><br>${m.content}`;div.onclick=()=>selectFriend(fid, profile.username);
      list.appendChild(div);
    }
  }
  async function getUsernameById(userId) {
    const { data } = await supabase.from('profiles').select('username').eq('id', userId).single();
    return data?.username || 'User';
  }

  async function loadPendingRequests(){
    const { data: requests } = await supabase.from('friendships').select('id, requester_id').eq('requested_id', currentUser.id).eq('status','pending');
    const pendingDiv=document.getElementById('pending-requests'); pendingDiv.innerHTML='';
    for(const r of requests){
      const { data: profile } = await supabase.from('profiles').select('username').eq('id', r.requester_id).single();
      const div=document.createElement('div'); 
      div.className = 'friend-request';
      div.innerHTML = `<span>${profile.username}</span>`;
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'friend-request-buttons';
      
      const acceptBtn=document.createElement('button'); 
      acceptBtn.textContent='Accept';
      acceptBtn.className = 'btn-primary';
      acceptBtn.style.padding = '4px 8px';
      acceptBtn.style.fontSize = '0.8rem';
      
      const rejectBtn=document.createElement('button'); 
      rejectBtn.textContent='Reject';
      rejectBtn.className = 'btn-secondary';
      rejectBtn.style.padding = '4px 8px';
      rejectBtn.style.fontSize = '0.8rem';
      
      acceptBtn.onclick=async ()=>{
        setTimeout(async ()=>{
          await supabase.from('friendships').update({status:'accepted'}).eq('id',r.id);
          loadFriends(); 
          loadPendingRequests();
        }, 300);
      };
      rejectBtn.onclick=async ()=>{
        setTimeout(async ()=>{
          await supabase.from('friendships').update({status:'rejected'}).eq('id',r.id);
          loadPendingRequests();
        }, 300);
      };
      
      buttonContainer.appendChild(acceptBtn); 
      buttonContainer.appendChild(rejectBtn);
      div.appendChild(buttonContainer);
      pendingDiv.appendChild(div);
    }
  }

  function selectFriend(fid, uname){ 
    // Remove selected class from all friends and global button
    document.querySelectorAll('.friend').forEach(f => f.classList.remove('selected'));
    document.getElementById('global-chat-btn').classList.remove('selected');
    
    // Add selected class to clicked friend
    if (fid) {
      currentFriend=fid; 
      currentFriendName=uname; 
      document.querySelector(`.friend[data-id="${fid}"]`)?.classList.add('selected');
      document.getElementById('chat-title').textContent = `Chat with ${uname}`;
    }
    loadMessages(); 
  }

  async function loadMessages(){
    const { data: msgs } = await supabase.from('messages').select('*').order('created_at',{ascending:true});
    const container=document.getElementById('messages'); 
    
    // Store current scroll position
    const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50;
    
    container.innerHTML='';
    let hasNewMessages = false;
    
    for(const m of msgs){
      if(currentFriend){
        if(m.from_id!==currentFriend && m.to_id!==currentFriend && m.from_id!==currentUser.id && m.to_id!==currentUser.id) continue;
      } else {
        if(m.to_id!==null) continue;
      }
      
      const div=document.createElement('div'); 
      const messageId = generateMessageId(m);
      const isNewMessage = !messageMemory.has(messageId);
      
      // Add flash class only for new messages
      const flashClass = isNewMessage ? 'flash' : '';
      div.className=`msg ${m.from_id===currentUser.id?'own':'other'} ${flashClass}`;
      
      // Format timestamp
      const time = new Date(m.created_at);
      const timeStr = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      div.innerHTML=`<span class="from">${m.from_id===currentUser.id?'You':(currentFriendName || 'User')}</span><span class="msg-time">${timeStr}</span><br>${m.content}`;
      container.appendChild(div);
      
      // Add to memory if it's a new message
      if (isNewMessage) {
        hasNewMessages = true;
        messageMemory.add(messageId);
        
        // Remove flash class after animation completes
        setTimeout(() => {
          div.classList.remove('flash');
        }, 1500);
      }
    }
    
    // Scroll to bottom if we were at bottom or if there are new messages
    if (wasAtBottom || hasNewMessages) {
      container.scrollTop = container.scrollHeight;
    }
  }

  const messageInput=document.getElementById('message-input');
  messageInput.addEventListener('input', async ()=>{
    await supabase.from('profiles').update({typing:true}).eq('id',currentUser.id);
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(async ()=>{
      await supabase.from('profiles').update({typing:false}).eq('id',currentUser.id);
    },1000);
  });

  document.getElementById('send-msg').onclick=sendMessage;
  messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

  async function sendMessage(){
    const content=messageInput.value.trim();
    if(!content) return;
    
    await supabase.from('messages').insert({from_id:currentUser.id,to_id:currentFriend,content});
    messageInput.value='';
    await supabase.from('profiles').update({typing:false}).eq('id',currentUser.id);
    loadMessages();
  }

  // Global chat button
  document.getElementById('global-chat-btn').onclick=()=>{
    // Remove selected class from all friends
    document.querySelectorAll('.friend').forEach(f => f.classList.remove('selected'));
    
    currentFriend=null; 
    currentFriendName='Global';
    document.getElementById('global-chat-btn').classList.add('selected');
    document.getElementById('chat-title').textContent = 'Global Chat';
    loadMessages();
  }

  // Update online users count
  async function updateOnlineCounter() {
    const { data: profiles } = await supabase.from('profiles').select('id').eq('online', true);
    const counter = document.getElementById('online-counter');
    if (profiles) {
      counter.textContent = profiles.length;
    }
  }

  // --- Initial load
  loadFriends(); 
  loadPendingRequests();
  updateOnlineCounter();
  
  // Set up real-time subscriptions for status updates
  const profilesSubscription = supabase
    .channel('profiles')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, 
      payload => {
        loadFriends();
        updateOnlineCounter();
      }
    )
    .subscribe();
}

// Add friend
document.getElementById('add-friend').onclick=async ()=>{
  const uname=document.getElementById('friend-username').value.trim();
  if(!uname) return;
  
  const { data, error } = await supabase.from('profiles').select('id').eq('username',uname).single();
  if(error || !data){alert('User not found'); return;}
  await supabase.from('friendships').insert({requester_id:currentUser.id, requested_id:data.id, status:'pending'});
  document.getElementById('friend-username').value='';
};
</script>
</body>
</html>
